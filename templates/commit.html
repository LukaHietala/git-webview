{% extends "base.html" %}

{% block title %}{{ repo_name }} - commit {{ commit.hexsha[:8] }}{% endblock %}

{% block content %}
<h2>Commit details</h2>

<table>
    <tr>
        <td>commit</td>
        <td class="sha">{{ commit.hexsha }}</td>
    </tr>
    <tr>
        <td>author</td>
        <td>{{ commit.author.name }} &lt;{{ commit.author.email }}&gt;</td>
    </tr>
    <tr>
        <td>date</td>
        <td>{{ commit.committed_datetime|datetime }}</td>
    </tr>
    {% if commit.parents %}
    <tr>
        <td>parent</td>
        <td>{% for parent in commit.parents %}<a href="/{{ repo_name }}/commit/{{ parent.hexsha }}">{{ parent.hexsha[:8] }}</a>{% if not loop.last %}, {% endif %}{% endfor %}</td>
    </tr>
    {% endif %}
    <tr>
        <td>tree</td>
        <!--TODO-->
        <td><a href="/{{ repo_name }}/tree?ref={{ commit.hexsha }}">{{ commit.tree.hexsha[:8] }}</a></td>
    </tr>
</table>

<h3>Commit message</h3>
<p>{{ commit.message }}</p>

<h3>Diff</h3>
{% for diff in diffs %}
<div class="diff-file">
    <div class="diff-file-header">
        {% if diff.new_file %}
        <span class="diff-status-new">new:</span> {{ diff.b_path }}
        {% elif diff.deleted_file %}
        <span class="diff-status-deleted">deleted:</span> {{ diff.a_path }}
        {% elif diff.renamed_file %}
        <span class="diff-status-renamed">renamed:</span> {{ diff.a_path }} -> {{ diff.b_path }}
        {% else %}
        {{ diff.a_path }}
        {% endif %}
    </div>
    {% if diff.diff %}
    <!--TODO: remove cursed parsing (that maybe works in all cases?)-->
    <!-- dont change indentation -->
    <pre class="diff-code">{% for line in diff.diff.decode('utf-8', errors='replace').splitlines() %}{% if line.startswith('+') and not line.startswith('+++') %}<span class="diff-added">{{ line }}</span>
{% elif line.startswith('-') and not line.startswith('---') %}<span class="diff-removed">{{ line }}</span>
{% elif line.startswith('@@') %}<span class="diff-hunk">{{ line }}</span>
{% else %}{{ line }}
{% endif %}{% endfor %}</pre>
    {% else %}
    <div class="diff-binary">Binary file</div>
    {% endif %}
</div>
{% endfor %}

{% if not diffs %}
<p>No changes in this commit</p>
{% endif %}
{% endblock %}
